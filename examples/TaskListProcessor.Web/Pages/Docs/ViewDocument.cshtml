@page "/Docs/{*path}"
@model TaskListProcessor.Web.Pages.Docs.ViewDocumentModel
@{
    ViewData["Title"] = Model.ViewModel.Metadata.Title;
    ViewData["Description"] = Model.ViewModel.Metadata.Description ?? "TaskListProcessor Documentation";
}

<!-- Breadcrumb -->
<nav aria-label="breadcrumb" class="bg-light border-bottom">
    <div class="container py-2">
        <ol class="breadcrumb mb-0">
            @foreach (var crumb in Model.ViewModel.Breadcrumbs)
            {
                if (crumb.IsActive)
                {
                    <li class="breadcrumb-item active" aria-current="page">@crumb.Text</li>
                }
                else
                {
                    <li class="breadcrumb-item">
                        <a href="@crumb.Url">@crumb.Text</a>
                    </li>
                }
            }
        </ol>
    </div>
</nav>

<!-- Main Content -->
<section class="py-5">
    <div class="container">
        <div class="row">
            
            <!-- Table of Contents Sidebar -->
            @if (Model.ViewModel.TableOfContents.Any())
            {
                <div class="col-lg-3 order-lg-2">
                    <div class="card border-0 shadow-sm sticky-top" style="top: 1rem;">
                        <div class="card-header bg-white border-bottom">
                            <h6 class="mb-0">
                                <i class="bi bi-list-ul me-2"></i>On This Page
                            </h6>
                        </div>
                        <div class="card-body">
                            <nav id="toc" class="nav flex-column">
                                @foreach (var item in Model.ViewModel.TableOfContents)
                                {
                                    var indent = (item.Level - 2) * 15; // H2 = 0, H3 = 15, H4 = 30
                                    <a class="nav-link py-1 text-decoration-none" 
                                       href="#@item.Id" 
                                       style="margin-left: @(indent)px;">
                                        @item.Text
                                    </a>
                                }
                            </nav>
                        </div>
                    </div>
                </div>
            }

            <!-- Document Content -->
            <div class="@(Model.ViewModel.TableOfContents.Any() ? "col-lg-9" : "col-lg-12") order-lg-1">
                
                <!-- Document Header -->
                <div class="mb-4">
                    <h1 class="display-4 fw-bold mb-3">@Model.ViewModel.Metadata.Title</h1>
                    
                    <div class="d-flex flex-wrap gap-3 align-items-center text-muted mb-3">
                        <span>
                            <i class="bi bi-folder me-1"></i>
                            @Model.ViewModel.Metadata.Category
                        </span>
                        @if (!string.IsNullOrEmpty(Model.ViewModel.Metadata.Subcategory))
                        {
                            <span>
                                <i class="bi bi-arrow-right me-1"></i>
                                @Model.ViewModel.Metadata.Subcategory
                            </span>
                        }
                        <span>
                            <i class="bi bi-clock me-1"></i>
                            @Model.ViewModel.Metadata.ReadingTimeMinutes min read
                        </span>
                        <span>
                            <i class="bi bi-calendar me-1"></i>
                            Updated @Model.ViewModel.Metadata.LastModified.ToString("MMM dd, yyyy")
                        </span>
                    </div>

                    @if (Model.ViewModel.Metadata.Tags.Any())
                    {
                        <div class="d-flex flex-wrap gap-2">
                            @foreach (var tag in Model.ViewModel.Metadata.Tags)
                            {
                                <span class="badge bg-secondary">@tag</span>
                            }
                        </div>
                    }
                </div>

                <!-- Markdown Content -->
                <div class="markdown-content">
                    @Html.Raw(Model.ViewModel.Content)
                </div>

                <!-- Previous/Next Navigation -->
                @if (Model.ViewModel.PreviousDocument != null || Model.ViewModel.NextDocument != null)
                {
                    <hr class="my-5">
                    <div class="row g-3">
                        <div class="col-md-6">
                            @if (Model.ViewModel.PreviousDocument != null)
                            {
                                <a href="/Docs/@Model.ViewModel.PreviousDocument.UrlPath" 
                                   class="card border h-100 text-decoration-none hover-shadow">
                                    <div class="card-body">
                                        <div class="text-muted small mb-2">
                                            <i class="bi bi-arrow-left me-1"></i>Previous
                                        </div>
                                        <h6 class="card-title mb-0">@Model.ViewModel.PreviousDocument.Title</h6>
                                    </div>
                                </a>
                            }
                        </div>
                        <div class="col-md-6">
                            @if (Model.ViewModel.NextDocument != null)
                            {
                                <a href="/Docs/@Model.ViewModel.NextDocument.UrlPath" 
                                   class="card border h-100 text-decoration-none hover-shadow">
                                    <div class="card-body text-end">
                                        <div class="text-muted small mb-2">
                                            Next <i class="bi bi-arrow-right ms-1"></i>
                                        </div>
                                        <h6 class="card-title mb-0">@Model.ViewModel.NextDocument.Title</h6>
                                    </div>
                                </a>
                            }
                        </div>
                    </div>
                }

                <!-- Feedback Section -->
                <div class="card bg-light border-0 mt-5">
                    <div class="card-body">
                        <h5 class="card-title">Was this helpful?</h5>
                        <p class="card-text text-muted">
                            Help us improve our documentation by providing feedback.
                        </p>
                        <a href="https://github.com/markhazleton/TaskListProcessor/issues/new?template=documentation.yml" 
                           class="btn btn-primary" target="_blank" rel="noopener noreferrer">
                            <i class="bi bi-github me-2"></i>Suggest an Edit
                        </a>
                    </div>
                </div>

            </div>
        </div>
    </div>
</section>

@section Scripts {
<!-- Mermaid for diagrams -->
<script src="https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.min.js"></script>
<!-- Prism for syntax highlighting -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/themes/prism-okaidia.min.css">
<script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/prism.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-csharp.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-json.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-bash.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-yaml.min.js"></script>

<script>
    // Initialize Mermaid
    mermaid.initialize({
        startOnLoad: true,
        theme: 'default',
        flowchart: {
            useMaxWidth: true,
            htmlLabels: true,
            curve: 'basis'
        }
    });

    // Add copy buttons to code blocks
    document.addEventListener('DOMContentLoaded', function() {
        document.querySelectorAll('pre code').forEach(function(codeBlock) {
            // Create copy button
            const button = document.createElement('button');
            button.className = 'btn btn-sm btn-outline-light position-absolute top-0 end-0 m-2';
            button.innerHTML = '<i class="bi bi-clipboard"></i>';
            button.title = 'Copy to clipboard';
            
            // Add click handler
            button.addEventListener('click', function() {
                navigator.clipboard.writeText(codeBlock.textContent).then(function() {
                    button.innerHTML = '<i class="bi bi-check"></i>';
                    setTimeout(function() {
                        button.innerHTML = '<i class="bi bi-clipboard"></i>';
                    }, 2000);
                });
            });
            
            // Make code block wrapper position relative
            const pre = codeBlock.parentElement;
            pre.style.position = 'relative';
            pre.appendChild(button);
        });

        // Smooth scroll for TOC links
        document.querySelectorAll('#toc a').forEach(function(link) {
            link.addEventListener('click', function(e) {
                e.preventDefault();
                const target = document.querySelector(this.getAttribute('href'));
                if (target) {
                    target.scrollIntoView({ behavior: 'smooth', block: 'start' });
                }
            });
        });

        // Highlight active TOC item on scroll
        const observer = new IntersectionObserver(function(entries) {
            entries.forEach(function(entry) {
                if (entry.isIntersecting) {
                    const id = entry.target.getAttribute('id');
                    document.querySelectorAll('#toc a').forEach(function(link) {
                        link.classList.remove('active', 'fw-bold');
                    });
                    const activeLink = document.querySelector(`#toc a[href="#${id}"]`);
                    if (activeLink) {
                        activeLink.classList.add('active', 'fw-bold');
                    }
                }
            });
        }, {
            rootMargin: '-100px 0px -66%'
        });

        document.querySelectorAll('h2[id], h3[id], h4[id]').forEach(function(heading) {
            observer.observe(heading);
        });
    });
</script>

<style>
/* Card styling for light/dark mode */
.card-header {
    background: var(--bs-body-bg);
    border-bottom: 1px solid var(--bs-border-color);
}

.card {
    background: var(--bs-body-bg);
    border: 1px solid var(--bs-border-color);
}

/* Markdown Content Styles */
.markdown-content {
    font-size: 1.1rem;
    line-height: 1.7;
}

.markdown-content h2, 
.markdown-content h3, 
.markdown-content h4 {
    margin-top: 2rem;
    margin-bottom: 1rem;
    font-weight: 600;
}

.markdown-content h2 {
    border-bottom: 2px solid #e9ecef;
    padding-bottom: 0.5rem;
}

.markdown-content p {
    margin-bottom: 1.25rem;
}

.markdown-content code {
    background: #f8f9fa;
    padding: 2px 6px;
    border-radius: 3px;
    font-size: 0.9em;
    color: #e83e8c;
}

.markdown-content pre {
    background: #282c34;
    padding: 1rem;
    border-radius: 6px;
    overflow-x: auto;
    margin: 1.5rem 0;
}

.markdown-content pre code {
    background: none;
    padding: 0;
    color: #abb2bf;
    font-size: 0.9rem;
}

.markdown-content blockquote {
    border-left: 4px solid #0d6efd;
    padding-left: 1rem;
    margin: 1.5rem 0;
    color: #6c757d;
}

.markdown-content table {
    width: 100%;
    margin: 1.5rem 0;
    border-collapse: collapse;
}

.markdown-content table th,
.markdown-content table td {
    border: 1px solid #dee2e6;
    padding: 0.75rem;
}

.markdown-content table th {
    background: #f8f9fa;
    font-weight: 600;
}

.markdown-content ul,
.markdown-content ol {
    margin: 1rem 0;
    padding-left: 2rem;
}

.markdown-content li {
    margin: 0.5rem 0;
}

.markdown-content a {
    color: #0d6efd;
    text-decoration: none;
}

.markdown-content a:hover {
    text-decoration: underline;
}

.markdown-content img {
    max-width: 100%;
    height: auto;
    border-radius: 6px;
    margin: 1.5rem 0;
}

/* TOC Link Styles - Fixed for light/dark mode visibility */
#toc a {
    color: #6c757d; /* Gray text for light mode */
    transition: color 0.2s ease;
}

#toc a:hover {
    color: #0d6efd; /* Blue on hover */
    text-decoration: none;
}

#toc a.active {
    color: #0d6efd; /* Blue for active */
    font-weight: bold;
}

/* Dark mode support for TOC links */
[data-bs-theme="dark"] #toc a {
    color: #adb5bd; /* Lighter gray for dark mode */
}

[data-bs-theme="dark"] #toc a:hover {
    color: #6ea8fe; /* Lighter blue on hover in dark mode */
}

[data-bs-theme="dark"] #toc a.active {
    color: #6ea8fe; /* Lighter blue for active in dark mode */
}

/* Hover Effects */
.hover-shadow {
    transition: box-shadow 0.3s ease;
}

.hover-shadow:hover {
    box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.15) !important;
    transform: translateY(-2px);
}

/* Mermaid Diagram Styles */
.mermaid {
    background: white;
    padding: 1rem;
    border-radius: 6px;
    margin: 1.5rem 0;
}
</style>
}
